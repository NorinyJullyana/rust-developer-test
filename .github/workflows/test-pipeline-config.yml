name: Rust CI Pipeline

on:
  push:
    branches:
      - develop
      - main
      - 'release/**'
  pull_request:
    branches:
      - develop
      - main
      - 'release/**'
  workflow_dispatch:

jobs:

  branch-order-validation:
    name: Validate branch flow
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Enforce branch order
        run: |
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"

          echo "Source: $HEAD"
          echo "Target: $BASE"

          # feature/* → develop
          if [[ "$HEAD" == feature/* && "$BASE" != "develop" ]]; then
            echo "ERROR: feature/* branches can only open PRs to develop"
            exit 1
          fi

          # develop → release/*
          if [[ "$HEAD" == "develop" && "$BASE" != release/* ]]; then
            echo "ERROR: develop can only open PRs to release/*"
            exit 1
          fi

          # release/* → main
          if [[ "$HEAD" == release/* && "$BASE" != "main" ]]; then
            echo "ERROR: release/* branches can only open PRs to main"
            exit 1
          fi

          echo "Branch flow valid"

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: branch-order-validation

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo fmt --all -- --check
      - run: cargo clippy --all-targets --all-features -- -D warnings
      - run: cargo build --all-features
      - run: cargo test --all-features
