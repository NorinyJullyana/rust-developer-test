name: Branch Governance Pipeline

on:
  pull_request:
    branches:
      - develop
      - 'release/*'
      - main

jobs:
  validate-branch-flow:
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch flow rules
        run: |
          SOURCE="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"

          echo "Source: $SOURCE"
          echo "Target: $TARGET"

          # Skip validation for hotfix branch
          if [[ "$SOURCE" == "hotfix" ]]; then
            echo "Skipping branch flow validation for hotfix branch"
            exit 0
          fi

          # Rule 1: feature/* → develop
          if [[ "$SOURCE" == feature/* && "$TARGET" == "develop" ]]; then
            echo "Valid: feature -> develop"

          # Rule 2: develop → release/*
          elif [[ "$SOURCE" == "develop" && "$TARGET" == release/* ]]; then
            echo "Valid: develop -> release"

          # Rule 3: release/* → main
          elif [[ "$SOURCE" == release/* && "$TARGET" == "main" ]]; then
            echo "Valid: release -> main"

          else
            echo "Invalid branch flow"
            exit 1
          fi

  validate-release-version:
    if: startsWith(github.base_ref, 'release/')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract name and version from Cargo.toml
        run: |
          NAME=$(grep '^name' Cargo.toml | head -1 | cut -d '"' -f2)
          VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d '"' -f2)

          echo "Package: $NAME"
          echo "Version: $VERSION"

          if [[ -z "$VERSION" ]]; then
            echo "Version not found in Cargo.toml"
            exit 1
          fi

          BRANCH_VERSION="${{ github.base_ref }}"
          BRANCH_VERSION="${BRANCH_VERSION#release/}"

          if [[ "$VERSION" != "$BRANCH_VERSION" ]]; then
            echo "Version in Cargo.toml does not match release branch name"
            exit 1
          fi

          echo "Release version validated successfully"
